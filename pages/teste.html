

<!doctype html>
<html lang="en" class="no-js">
  <head>
    

<meta charset="utf-8">



<!-- begin SEO -->









<title>Pagina Work - Pietro S. Consonni</title>










  <link rel="canonical" href="/pages/teste.html">





  

  






  <script type="application/ld+json">
    {
      "@context" : "http://schema.org",
      "@type" : "Person",
      "name" : "Your Name",
      "url" : "",
      "sameAs" : null
    }
  </script>






<!-- end SEO -->

<!-- Open Graph protocol data (https://ogp.me/), used by social media -->
<meta property="og:locale" content="en-US">
<meta property="og:site_name" content="Pietro S. Consonni"> 
<meta property="og:title" content="Pagina Work">



  <meta property="og:url" content="/teste/">





<!-- end Open Graph protocol -->

<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Pietro S. Consonni Feed">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">

<meta http-equiv="cleartype" content="on">
    

<!-- start custom head snippets -->

<!-- Support for Academicons -->
<link rel="stylesheet" href="/assets/css/academicons.css"/>

<!-- favicon from https://commons.wikimedia.org/wiki/File:OOjs_UI_icon_academic-progressive.svg -->
<link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-180x180.png"/>
<link rel="icon" type="image/svg+xml" href="/images/favicon.svg"/>
<link rel="icon" type="image/png" href="/images/favicon-32x32.png" sizes="32x32"/>
<link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192"/>
<link rel="manifest" href="/images/manifest.json"/>
<link rel="icon" href="/images/favicon.ico"/>
<meta name="theme-color" content="#ffffff"/>

<!-- end custom head snippets -->

  </head>

  <body>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->
    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        <button><div class="navicon"></div></button>
        <ul class="visible-links">
          <li class="masthead__menu-item masthead__menu-item--lg persist"><a href="/">Pietro S. Consonni</a></li>
          
            
            <li class="masthead__menu-item"><a href="/pages/research.html">Research</a></li>
          
            
            <li class="masthead__menu-item"><a href="/pages/teaching.html">Teaching</a></li>
          
            
            <li class="masthead__menu-item"><a href="/pages/prices.html">Prices</a></li>
          
            
            <li class="masthead__menu-item"><a href="/pages/price-analyses.html">Price Analyses</a></li>
          
            
            <li class="masthead__menu-item"><a href="/pages/macro-analyses.html">Macro Analyses</a></li>
          
            
            <li class="masthead__menu-item"><a href="/pages/teste.html">Teste Espaco</a></li>
          
          <li id="theme-toggle" class="masthead__menu-item persist tail">
            <a role="button" aria-labelledby="theme-icon"><i id="theme-icon" class="fa-solid fa-sun" aria-hidden="true" title="toggle theme"></i></a>
          </li>
        </ul>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>

    <div class="">
      





<div id="main" role="main">
  



  <article class="page" itemscope itemtype="http://schema.org/CreativeWork">
    <meta itemprop="headline" content="Pagina Work">
    
    
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 class="page__title" itemprop="headline">Pagina Work
</h1>
          
        
        
            
        </header>
      

      <section class="page__content" itemprop="text">
        <nav id="mainSections" style="display:flex; gap:12px; align-items:center; margin-bottom:12px; flex-wrap:wrap;"></nav>

<div style="max-width:1200px; margin:0 auto; padding:12px;">
  <h1>PIB USD BRL analise</h1>
  <div id="allContent" style="display:flex; gap:24px; flex-direction:column;"></div>
</div>

<!-- Dependencies (single copy of each) -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>

<style>
/* shared */
.preset-tabs{ display:flex; gap:10px; flex-wrap:wrap; margin: 8px 0 18px 0; align-items:center; }
.preset-tab{ padding:8px 14px; border-radius:999px; cursor:pointer; font-weight:600; color:#444; border:1px solid transparent; background:transparent;}
.preset-tab.active{ background:#fff; color:#0b5fff; border-color:#cfe0ff; box-shadow:0 1px 0 rgba(11,95,255,0.06), inset 0 -2px 0 rgba(11,95,255,0.06); }

.section-title{ font-size:18px; font-weight:700; margin: 8px 0; }
.chart-placeholder{ width:100%; min-height:320px; height:360px; }

/* table styles - MADE LARGER + horizontal scroll */
.table-card { border-top:1px solid #eee; padding:12px 0; }
.table-title { font-weight:700; margin-bottom:8px; }
.tbl-wrap { display:flex; gap:14px; align-items:flex-start; }
.tbl-area { flex:1 1 80%; overflow:auto; max-height:700px; }           /* maior altura e ocupa mais espaço */
.chart-area { width:320px; min-width:260px; height:360px; border:1px solid #f0f0f0; border-radius:6px; padding:6px; box-sizing:border-box;}
table.my-table { width:1200px; min-width:900px; border-collapse:collapse; font-family:inherit; font-size:14px; table-layout:fixed; } /* maior fonte e largura fixa para forçar scroll-x */
table.my-table th, table.my-table td { border-bottom:1px solid #eee; padding:10px 8px; text-align:left; vertical-align:middle; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
table.my-table th { background:#fafafa; position:relative; cursor:pointer; user-select:none; }
table.my-table th.sort-asc::after { content:"▲"; font-size:10px; position:absolute; right:8px; top:50%; transform:translateY(-50%); color:#0b5fff; }
table.my-table th.sort-desc::after { content:"▼"; font-size:10px; position:absolute; right:8px; top:50%; transform:translateY(-50%); color:#0b5fff; }
.col-filter { width:100%; box-sizing:border-box; padding:8px; font-size:14px; margin-bottom:6px; }
.row-count { color:#666; font-size:13px; margin-bottom:8px; }
.table-toolbar { display:flex; gap:8px; align-items:center; margin-bottom:8px; }
.btn { padding:6px 10px; border-radius:6px; border:1px solid #ddd; background:white; cursor:pointer; }

/* mobile adjustments */
@media (max-width:900px){
  table.my-table { width:900px; min-width:700px; font-size:13px; }
  .tbl-area { max-height:420px; }
}
</style>

<script>
/* ---------- CONFIG ---------- */
const DATA_DIR_CSV = "/files/data/";           // CSV files folder
const DATA_DIR_TABLES = "/files/data_tables/"; // XLSX files folder
const FALLBACK_CSV = ["acúcar.csv", "brl_usd.csv", "cafe.csv", "chf_usd.csv", "cobre.csv", "eur_usd.csv", "gas_natural.csv", "gbp_usd.csv", "milho.csv", "ouro.csv", "petróleo_brent.csv", "petróleo_wti.csv", "soja.csv", "trigo.csv"];   // if no index / files.json, list CSV filenames here
const FALLBACK_XLSX = [];  // fallback XLSX filenames here

/* ---------- utilities ---------- */
function basename(p){ return p.split("/").filter(Boolean).pop(); }
function isCSV(n){ return /\.csv$/i.test(n); }
function isXLSX(n){ return /\.(xlsx|xls)$/i.test(n); }
function safeId(s){ return 'id_' + btoa(unescape(encodeURIComponent(s))).replace(/=/g,''); }
function toDateSafe(v){
  if(v instanceof Date) return v;
  if(v==null || v==="") return null;
  if(typeof v === 'number') return new Date(Math.round((v-25569)*86400*1000));
  if(typeof v === 'string'){
    const t=v.trim();
    if(/^\d{4}-\d{2}-\d{2}/.test(t)){ const d=new Date(t); return isNaN(d)?null:d; }
    if(/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(t)){ const [dd,mm,yyyy]=t.split('/'); const d=new Date(+yyyy,+mm-1,+dd); return isNaN(d)?null:d; }
    const d2=new Date(t); return isNaN(d2)?null:d2;
  }
  return null;
}

/* ---------- discover files (SKIP DISCOVERY -> USE MANUAL LIST) ---------- */
// GitHub Pages and some local servers don't support directory listing reliably.
// We will always use the manual list (FALLBACK_CSV/XLSX) which is safer.
async function discoverFilesIn(dir, isMatch, fallback){
  return fallback.slice();
}

/* ---------- load CSV (PapaParse) ---------- */
async function loadCSVFile(fname, dir){
  const url = dir + fname;
  const r = await fetch(url);
  if(!r.ok) throw new Error("HTTP " + r.status);
  const txt = await r.text();
  const parsed = Papa.parse(txt, { header:true, dynamicTyping:true, skipEmptyLines:true, transformHeader: h=>h.trim() });
  if(parsed.errors && parsed.errors.length) console.warn("CSV parse errors", fname, parsed.errors.slice(0,6));
  const rows = parsed.data.filter(r => r && Object.values(r).some(v => v !== null && v !== ""));
  return rows;
}

/* ---------- load XLSX (SheetJS) ---------- */
async function loadXlsxFile(fname, dir){
  const url = dir + fname;
  const r = await fetch(url);
  if(!r.ok) throw new Error("HTTP " + r.status);
  const ab = await r.arrayBuffer();
  const wb = XLSX.read(ab, { type:'array', cellDates:true });
  const sheet = wb.SheetNames[0];
  const ws = wb.Sheets[sheet];
  const json = XLSX.utils.sheet_to_json(ws, { defval:null });
  return json;
}

/* ---------- CSV UI block (controls + Plotly) ---------- */
function buildCsvBlock(fname, rows){
  const container = document.querySelector('#allContent');
  const id = safeId('csv_'+fname);

  const section = document.createElement('section');
  section.style.borderTop='1px solid #eee';
  section.style.padding='12px 0';

  const title = document.createElement('div'); title.className='section-title'; title.textContent = fname.replace(/%20/g,' ');
  section.appendChild(title);

  // presets
  const presetsRow = document.createElement('div'); presetsRow.className='preset-tabs'; section.appendChild(presetsRow);

  // controls grid
  const controls = document.createElement('div');
  controls.innerHTML = `
    <div style="display:grid; gap:12px; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); align-items:end;">
      <div><label>Coluna Y</label><select id="y_${id}" style="width:100%; padding:6px;"></select></div>
      <div><label>De</label><input type="date" id="from_${id}" style="width:100%; padding:6px;"></div>
      <div><label>Até</label><input type="date" id="to_${id}" style="width:100%; padding:6px;"></div>
      <div><label>Suavização</label><select id="smooth_${id}" style="width:100%; padding:6px;"><option value="1">Sem</option><option value="3">3</option><option value="5">5</option><option value="10">10</option></select></div>
      <div><label>Subamostragem</label><select id="sample_${id}" style="width:100%; padding:6px;"><option value="none">Nenhuma</option><option value="nth">Cada N</option><option value="period">Por período</option></select></div>
      <div id="nthBox_${id}" style="display:none;"><label>N</label><input type="number" id="nth_${id}" min="2" value="5" style="width:100%; padding:6px;"></div>
      <div id="periodBox_${id}" style="display:none;"><label>Período</label><select id="period_${id}" style="width:100%; padding:6px;"><option value="D">Dia</option><option value="W" selected>Semana</option><option value="M">Mês</option><option value="Q">Trimestre</option><option value="Y">Ano</option></select></div>
    </div>
  `;
  section.appendChild(controls);


  // insere painel de filtros de forma segura (HTML como string)
  section.insertAdjacentHTML('beforeend', `
    <details id="details_filters_${id}" open style="margin-top:8px; border:1px solid #eee; padding:8px; border-radius:8px; background:#fcfcfc;">
      <summary style="cursor:pointer; font-weight:600; margin-bottom:8px;">Filtros (opcionais)</summary>
      <div style="display:flex; gap:12px; align-items:center; margin:8px 0;">
        <button id="addFilterBtn_${id}" class="btn" style="padding:8px 12px;">Adicionar filtro</button>
        <button id="clearFiltersBtn_${id}" class="btn" style="padding:8px 12px;">Limpar filtros</button>
        <div id="activeFilters_${id}" style="display:flex; gap:8px; flex-wrap:wrap;"></div>
      </div>
    </details>
  `);


  // chart area
  const chartDiv = document.createElement('div'); chartDiv.id = 'chart_' + id; chartDiv.className='chart-placeholder';
  section.appendChild(chartDiv);

  container.appendChild(section);

  // init controls
  initCsvControls(fname, rows, id);
}

/* ---------- init CSV controls + render ---------- */
function initCsvControls(fname, rows, id){
  const ALL_COLS = rows.length ? Object.keys(rows[0]) : [];
  const ySel = document.getElementById(`y_${id}`);
  const fromEl = document.getElementById(`from_${id}`);
  const toEl = document.getElementById(`to_${id}`);
  const smooth = document.getElementById(`smooth_${id}`);
  const sample = document.getElementById(`sample_${id}`);

  const numCols = ALL_COLS.filter(c => rows.some(r => typeof r[c] === 'number' && isFinite(r[c])));
  const opts = numCols.length ? numCols : ALL_COLS;
  ySel.innerHTML = (opts||[]).map(c => `<option value="${c}">${c}</option>`).join('');

  const dateCol = ALL_COLS.find(c => /^(date|data|dt)$/i.test(c)) || ALL_COLS[0];
  const ds = rows.map(r => toDateSafe(r[dateCol])).filter(Boolean);
  if(ds.length){ fromEl.valueAsDate = new Date(Math.min(...ds.map(d=>d.getTime()))); toEl.valueAsDate = new Date(Math.max(...ds.map(d=>d.getTime()))); }

  // presets
  const parentSection = document.getElementById('chart_'+id).closest('section');
  const pRow = parentSection ? parentSection.querySelector('.preset-tabs') : null;
  const presets = [
    { label:'12 meses', fn: dmax => [addMonths(dmax,-12), dmax] },
    { label:'18 meses', fn: dmax => [addMonths(dmax,-18), dmax] },
    { label:'Todos', fn: ()=> {
        const ds2 = rows.map(r=> toDateSafe(r[dateCol])).filter(Boolean);
        if(!ds2.length) return [new Date(2000,0,1), new Date()];
        return [new Date(Math.min(...ds2.map(d=>d.getTime()))), new Date(Math.max(...ds2.map(d=>d.getTime())))];
      } }
  ];
  if(pRow){
    pRow.innerHTML = '';
    presets.forEach(p=>{
      const b = document.createElement('button'); b.className='preset-tab'; b.textContent = p.label;
      b.addEventListener('click', ()=>{ Array.from(pRow.querySelectorAll('.preset-tab')).forEach(x=>x.classList.remove('active')); b.classList.add('active'); const dmax = ds.length ? new Date(Math.max(...ds.map(d=>d.getTime()))) : new Date(); const r = p.fn(dmax); if(r && r.length===2){ fromEl.value = r[0].toISOString().slice(0,10); toEl.value = r[1].toISOString().slice(0,10); renderCsv(fname, rows, id); } });
      pRow.appendChild(b);
    });
  }

  sample.addEventListener('change', ()=>{ document.getElementById(`nthBox_${id}`).style.display = sample.value==='nth' ? 'block' : 'none'; document.getElementById(`periodBox_${id}`).style.display = sample.value==='period' ? 'block' : 'none'; renderCsv(fname, rows, id); });
  document.getElementById(`nth_${id}`).addEventListener('change', ()=>renderCsv(fname, rows, id));
  document.getElementById(`period_${id}`).addEventListener('change', ()=>renderCsv(fname, rows, id));

  ySel.addEventListener('change', ()=>renderCsv(fname, rows, id));
  fromEl.addEventListener('change', ()=>renderCsv(fname, rows, id));
  toEl.addEventListener('change', ()=>renderCsv(fname, rows, id));
  smooth.addEventListener('change', ()=>renderCsv(fname, rows, id));

  // filters
  const addBtn = document.getElementById(`addFilterBtn_${id}`);
  const activeWrap = document.getElementById(`activeFilters_${id}`);
  let ACTIVE_FILTERS = [];
  addBtn.addEventListener('click', (e)=>{
    e.preventDefault();
    const col = prompt("Coluna para filtrar (exatamente):");
    if(!col) return;
    const op = prompt("Operador: >, <, =, !=, between, contains, in (comma-separated)","=");
    if(!op) return;
    let v1=null,v2=null,vs=null;
    if(op==='between'){ v1 = prompt("Valor 1:"); v2 = prompt("Valor 2:"); }
    else if(op==='in'){ vs = prompt("Valores separados por vírgula:"); vs = vs ? vs.split(',').map(s=>s.trim()) : []; }
    else { v1 = prompt("Valor:"); }
    const idf = Math.random().toString(36).slice(2);
    const f = { id:idf, col, op };
    if(vs) f.vs = vs; else { f.v1 = v1; if(v2) f.v2 = v2; }
    ACTIVE_FILTERS.push(f);
    drawActive();
    renderCsv(fname, rows, id);
  });
  function drawActive(){ activeWrap.innerHTML=''; for(const f of ACTIVE_FILTERS){ const chip = document.createElement('div'); chip.className='btn'; chip.style.display='inline-flex'; chip.style.alignItems='center'; chip.textContent = `${f.col} ${f.op} ${f.vs ? f.vs.join(',') : (f.v2 ? `${f.v1} e ${f.v2}` : f.v1)}`; const rm = document.createElement('button'); rm.textContent='×'; rm.style.marginLeft='8px'; rm.addEventListener('click', ()=>{ ACTIVE_FILTERS = ACTIVE_FILTERS.filter(x=>x.id!==f.id); drawActive(); renderCsv(fname, rows, id); }); chip.appendChild(rm); activeWrap.appendChild(chip);} }
  document.getElementById(`chart_${id}`).ACTIVE_FILTERS = ACTIVE_FILTERS;

  renderCsv(fname, rows, id);
}

/* ---------- CSV rendering ---------- */
function renderCsv(fname, rows, id){
  const yField = document.getElementById(`y_${id}`).value;
  const fromEl = document.getElementById(`from_${id}`);
  const toEl   = document.getElementById(`to_${id}`);
  const smooth = document.getElementById(`smooth_${id}`);
  const sample = document.getElementById(`sample_${id}`);
  const dateCol = Object.keys(rows[0]||{}).find(c=> /^(date|data|dt)$/i.test(c)) || Object.keys(rows[0]||{})[0];

  const fd = fromEl.valueAsDate || new Date(-8640000000000000);
  const td = toEl.valueAsDate   || new Date(8640000000000000);
  const ACTIVE_FILTERS = document.getElementById(`chart_${id}`).ACTIVE_FILTERS || [];

  let filtered = rows.map(r => ({...r, __d: toDateSafe(r[dateCol])}))
    .filter(r => r.__d && r.__d >= fd && r.__d <= td)
    .filter(r => applySimpleFilters(r, ACTIVE_FILTERS))
    .filter(r => r[yField] !== null && r[yField] !== undefined)
    .sort((a,b)=> a.__d - b.__d);

  // sub-sampling
  if(sample.value === 'period'){
    const agg = aggregateByPeriod(filtered, document.getElementById(`period_${id}`).value, yField);
    filtered = agg.map(a=> ({ ...a, __d: a.__d }));
  } else if(sample.value === 'nth'){
    const step = Math.max(2, parseInt(document.getElementById(`nth_${id}`).value||'2',10));
    filtered = filtered.filter((_,i)=> i % step === 0);
  }

  let x = filtered.map(r => r.__d);
  let y = filtered.map(r => typeof r[yField] === 'number' ? r[yField] : Number(r[yField]));

  const win = parseInt(smooth.value || '1', 10);
  if(win > 1) y = movingAvg(y, win);

  const trace = { x, y, mode:'lines', name: yField };
  const layout = { margin:{t:30}, xaxis:{type:'date', rangeslider:{visible:true}}, yaxis:{title:yField} };
  Plotly.react('chart_' + id, [trace], layout, {responsive:true});
}

function applySimpleFilters(r, filters){
  for(const f of filters){
    const v = r[f.col];
    if(f.op === 'between'){ const a = isNaN(Number(f.v1)) ? toDateSafe(f.v1)?.getTime() : Number(f.v1); const b = isNaN(Number(f.v2)) ? toDateSafe(f.v2)?.getTime() : Number(f.v2); const nv = (v instanceof Date ? v.getTime() : (typeof v==='number'? v : (toDateSafe(v)?.getTime()))); if(!(nv>=a && nv<=b)) return false; }
    else if(f.op === '>'){ const nv = Number(v); if(!(nv >= Number(f.v1))) return false; }
    else if(f.op === '<'){ const nv = Number(v); if(!(nv <= Number(f.v1))) return false; }
    else if(f.op === '='){ if(String(v) !== String(f.v1)) return false; }
    else if(f.op === '!='){ if(String(v) === String(f.v1)) return false; }
    else if(f.op === 'in'){ if(!f.vs.includes(String(v))) return false; }
    else if(f.op === 'contains'){ if(!String(v).toLowerCase().includes(String(f.v1).toLowerCase())) return false; }
  }
  return true;
}

/* ---------- helpers ---------- */
// Corrigido: usar `let sum` (const proibiria sum += ...)
function movingAvg(arr, n) {
  const out = [];
  const q = [];
  let sum = 0;
  for (let i = 0; i < arr.length; i++) {
    const v = Number(arr[i]) || 0;
    q.push(v);
    sum += v;
    if (q.length > n) sum -= q.shift();
    out.push(q.length === n ? sum / n : null);
  }
  return out;
}

function aggregateByPeriod(rows, period, yField){
  if(period === 'D') return rows;
  const buckets = new Map(), weekMs = 7*24*3600*1000;
  for(const r of rows){
    const d = r.__d; let key, repr;
    if(period==='W'){ const w=Math.floor(d.getTime()/weekMs); key=`W${w}`; repr = new Date(w*weekMs); }
    else if(period==='M'){ key=`M${d.getFullYear()}-${d.getMonth()}`; repr = new Date(Date.UTC(d.getFullYear(), d.getMonth(),1)); }
    else if(period==='Q'){ const q=Math.floor(d.getMonth()/3)+1; key=`Q${d.getFullYear()}-${q}`; repr=new Date(Date.UTC(d.getFullYear(), (q-1)*3,1)); }
    else if(period==='Y'){ key=`Y${d.getFullYear()}`; repr=new Date(Date.UTC(d.getFullYear(),0,1)); }
    const acc = buckets.get(key) || { sum:0, n:0, __d: repr }; acc.sum += Number(r[yField]); acc.n += 1; buckets.set(key, acc);
  }
  return Array.from(buckets.values()).map(b=> ({ __d: b.__d, [yField]: b.sum / b.n })).sort((a,b)=> a.__d - b.__d);
}
function addMonths(d,m){ const dt=new Date(d.getTime()); dt.setMonth(dt.getMonth()+m); return dt; }

/* ---------- XLSX table UI (interactive table + side chart) ---------- */
function buildTableCard(name, rows){
  const container = document.querySelector('#allContent');
  const id = safeId('xlsx_'+name);

  const card = document.createElement('div'); card.className='table-card';
  const title = document.createElement('div'); title.className='table-title'; title.textContent = name.replace(/%20/g,' ');
  card.appendChild(title);

  const toolbar = document.createElement('div'); toolbar.className='table-toolbar';
  const rowCount = document.createElement('div'); rowCount.className='row-count'; rowCount.id = 'count_' + id;
  toolbar.appendChild(rowCount);

  // FILTERS controls added to toolbar (visible)
  const filtersWrap = document.createElement('div');
  filtersWrap.style.display = 'flex';
  filtersWrap.style.gap = '8px';
  filtersWrap.style.alignItems = 'center';

  const addFilterBtn = document.createElement('button');
  addFilterBtn.className = 'btn';
  addFilterBtn.id = 'addFilterBtn_' + id;
  addFilterBtn.textContent = 'Adicionar filtro';

  const clearFilterBtn = document.createElement('button');
  clearFilterBtn.className = 'btn';
  clearFilterBtn.id = 'clearFiltersBtn_' + id;
  clearFilterBtn.textContent = 'Limpar filtros';

  const activeFiltersDiv = document.createElement('div');
  activeFiltersDiv.id = 'activeFilters_' + id;
  activeFiltersDiv.style.display = 'flex';
  activeFiltersDiv.style.gap = '8px';
  activeFiltersDiv.style.flexWrap = 'wrap';

  filtersWrap.appendChild(addFilterBtn);
  filtersWrap.appendChild(clearFilterBtn);
  filtersWrap.appendChild(activeFiltersDiv);

  toolbar.appendChild(filtersWrap);

  const btnReset = document.createElement('button'); btnReset.className='btn'; btnReset.textContent='Reset filtros/sort';
  toolbar.appendChild(btnReset);
  card.appendChild(toolbar);


  const wrap = document.createElement('div'); wrap.className='tbl-wrap';
  const tblArea = document.createElement('div'); tblArea.className='tbl-area';
  const table = document.createElement('table'); table.className='my-table'; table.id = 'table_' + id;
  tblArea.appendChild(table);
  wrap.appendChild(tblArea);

  const chartArea = document.createElement('div'); chartArea.className='chart-area';
  const chartDiv = document.createElement('div'); chartDiv.id = 'chart_' + id; chartDiv.style.width='100%'; chartDiv.style.height='100%';
  chartArea.appendChild(chartDiv);
  wrap.appendChild(chartArea);

  card.appendChild(wrap);
  container.appendChild(card);

  initInteractiveTable(id, rows);
}

/* interactive table implementation (filters + sort + header->plot) */
function initInteractiveTable(id, rows){
  const table = document.getElementById('table_' + id);
  const countEl = document.getElementById('count_' + id);
  const chartDivId = 'chart_' + id;
  if(!rows || !rows.length){ table.innerHTML = "<tr><td style='color:#666'>Tabela vazia</td></tr>"; if(countEl) countEl.textContent = "0 linhas"; return; }
  const cols = Object.keys(rows[0]);
  const colInfo = {};
  cols.forEach(c=>{
    let isNum=false, isDate=false;
    for(const r of rows){
      const v = r[c];
      if(v==null || v==="") continue;
      if(typeof v === 'number' && isFinite(v)){ isNum=true; }
      else if(toDateSafe(v)) { isDate = true; }
    }
    colInfo[c] = { isNum, isDate };
  });
  let activeFilters = {};
  let sortState = { col:null, dir:null };
  let filteredRows = rows.slice();

  function renderHeader(){
    table.innerHTML = '';
    const thead = document.createElement('thead');
    const trFilters = document.createElement('tr');
    const trHead = document.createElement('tr');
    cols.forEach(col=>{
      const thFilter = document.createElement('th');
      const info = colInfo[col];
      const inp = document.createElement('input'); inp.className='col-filter';
      inp.type = info.isDate ? 'date' : (info.isNum ? 'number' : 'search');
      inp.placeholder = 'filtrar';
      inp.value = activeFilters[col] || '';
      inp.addEventListener('input', ()=>{ activeFilters[col] = inp.value; applyFiltersAndRender(); });
      thFilter.appendChild(inp);
      trFilters.appendChild(thFilter);

      const th = document.createElement('th'); th.textContent = col;
      if(sortState.col === col) th.classList.add(sortState.dir === 'asc' ? 'sort-asc' : 'sort-desc');
      th.addEventListener('click', ()=>{ toggleSort(col); });
      th.addEventListener('dblclick', ()=>{ activeFilters[col]=''; trFilters.querySelectorAll('input')[cols.indexOf(col)].value=''; applyFiltersAndRender(); });
      trHead.appendChild(th);
    });
    thead.appendChild(trFilters); thead.appendChild(trHead);
    table.appendChild(thead);
  }

  function renderBody(){
    const old = table.querySelector('tbody'); if(old) old.remove();
    const tbody = document.createElement('tbody');
    filteredRows.forEach(row=>{
      const tr = document.createElement('tr');
      cols.forEach(col=>{
        const td = document.createElement('td');
        const v = row[col];
        if(colInfo[col].isDate){ const d = toDateSafe(v); td.textContent = d ? d.toISOString().slice(0,10) : (v==null?'':String(v)); }
        else td.textContent = v==null ? '' : String(v);
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });
    table.appendChild(tbody);
    countEl.textContent = filteredRows.length + ' linhas';
    // ensure horizontal scroll visible if table wider than container
    const wrapper = table.closest('.tbl-area');
    if(wrapper){ wrapper.scrollLeft = 0; }
  }

  function applyFiltersAndRender(){
    filteredRows = rows.filter(r=>{
      for(const col of cols){
        const f = activeFilters[col];
        if(f==null || f==='') continue;
        const v = r[col]; const info = colInfo[col];
        if(info.isNum){
          const n = (typeof v === 'number' ? v : Number(v)); const fv = Number(f);
          if(isNaN(fv) || isNaN(n) || n !== fv) return false;
        } else if(info.isDate){
          const dv = toDateSafe(v); const fv = toDateSafe(f);
          if(!dv || !fv) return false;
          if(!(dv.getFullYear()===fv.getFullYear() && dv.getMonth()===fv.getMonth() && dv.getDate()===fv.getDate())) return false;
        } else {
          const s = String(v ?? '').toLowerCase(); const q = String(f ?? '').toLowerCase();
          if(!s.includes(q)) return false;
        }
      }
      return true;
    });

    if(sortState.col){
      const c = sortState.col; const dir = sortState.dir; const info = colInfo[c];
      filteredRows.sort((a,b)=>{
        const va = a[c], vb = b[c];
        if(info.isNum){ const na = Number(va), nb = Number(vb); if(isNaN(na)&&isNaN(nb)) return 0; if(isNaN(na)) return 1; if(isNaN(nb)) return -1; return dir==='asc'? na-nb : nb-na; }
        if(info.isDate){ const da = toDateSafe(va)?.getTime()||0, db = toDateSafe(vb)?.getTime()||0; return dir==='asc'? da-db: db-da; }
        const sa = String(va ?? '').localeCompare(String(vb ?? '')); return dir==='asc'? sa : -sa;
      });
    }

    renderHeader();
    renderBody();
  }

  function toggleSort(col){
    if(sortState.col === col){ sortState.dir = sortState.dir === 'asc' ? 'desc' : (sortState.dir === 'desc' ? null : 'asc'); if(sortState.dir===null) sortState.col=null; }
    else { sortState.col = col; sortState.dir='asc'; }
    applyFiltersAndRender();
    if(colInfo[col].isNum) plotColumn(col);
    else clearChart();
  }

  function clearChart(){ const ch = document.getElementById(chartDivId); if(ch) ch.innerHTML = "<div style='color:#666; padding:10px;'>Clique em um header de coluna numérica para gerar o gráfico.</div>"; }

  function plotColumn(col){
    const dateCol = cols.find(c => colInfo[c].isDate);
    const x = filteredRows.map((r,i)=> dateCol ? (toDateSafe(r[dateCol]) || new Date(i)) : i);
    const y = filteredRows.map(r=> Number(r[col]));
    const hasDate = !!dateCol;
    Plotly.react(chartDivId, [{ x, y, mode:'lines', name:col }], { margin:{t:30}, xaxis: hasDate? {type:'date', title:dateCol} : {title:'index'}, yaxis:{title:col} }, {responsive:true});
  }

  function resetFiltersAndSort(){ activeFilters={}; sortState={col:null,dir:null}; applyFiltersAndRender(); clearChart(); }

  // wire reset button (closest .table-card .btn)
  const card = document.getElementById('table_' + id).closest('.table-card');
  if(card){
    const resetBtn = card.querySelector('.btn');
    if(resetBtn) resetBtn.addEventListener('click', resetFiltersAndSort);
  }

  applyFiltersAndRender();
  clearChart();
}

/* ---------- startup: discover and load both CSVs and XLSX ---------- */
async function startAllWork(){
  // discover CSVs
  const csvFiles = await discoverFilesIn(DATA_DIR_CSV, isCSV, FALLBACK_CSV);
  for(const f of csvFiles){ try { const rows = await loadCSVFile(f, DATA_DIR_CSV); buildCsvBlock(f, rows); } catch(e){ console.error("CSV load error", f, e); } }

  // discover XLSX
  const xlsxFiles = await discoverFilesIn(DATA_DIR_TABLES, isXLSX, FALLBACK_XLSX);
  for(const f of xlsxFiles){ try { const rows = await loadXlsxFile(f, DATA_DIR_TABLES); buildTableCard(f, rows); } catch(e){ console.error("XLSX load error", f, e); } }
}

/* run */
startAllWork();
</script>



        

        
      </section>

      <footer class="page__meta">
        
        




      </footer>

      

      


    </div>

    
  </article>

  
  
</div>

    </div>

    <div class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<a href="/sitemap/">Sitemap</a>

<!-- Support for MatJax -->
<script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
<script defer src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" id="MathJax-script"></script>

<!-- Support for Plotly -->
<script defer src='https://cdnjs.cloudflare.com/ajax/libs/plotly.js/3.0.1/plotly.min.js'></script>

<!-- Support for Mermaid -->
<script type="module">
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs';
    mermaid.initialize({startOnLoad:true, theme:'default'});
    await mermaid.run({querySelector:'code.language-mermaid'});
</script>

<!-- end custom footer snippets -->

        


<div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>Follow:</strong></li>
    
    
      <li><a href="http://github.com/pietcon"><i class="fab fa-github" aria-hidden="true"></i> GitHub</a></li>
    
    
    
    <li><a href="/feed.xml"><i class="fa fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
    
  </ul>
</div>


<div class="page__footer-copyright">
  &copy; 2025 Your Name, Powered by <a href="http://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://github.com/academicpages/academicpages.github.io">AcademicPages</a>, a fork of <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.<br />
  Site last updated 2025-10-16
</div>

      </footer>
    </div>

    <script type="module" src="/assets/js/main.min.js"></script>








  </body>
</html>




